# RRStack — Project‑specific Assistant Instructions

Last updated: 2025-09-28 (UTC)

Scope

- This file contains project-specific assistant behavior guidelines for RRStack.
- Durable product requirements live in stan.requirements.md.
- Repo‑agnostic policies and response format are governed by .stan/system/stan.system.md.

Release discipline (hard rule)

- Do NOT bump the package version or edit CHANGELOG.md in normal patches.
- Versioning and changelog updates are owned by the release workflow (release-it + auto-changelog).

Generated artifacts policy

- assets/rrstackconfig.schema.json is generated by scripts/gen-schema.ts.
- Do not hand-edit generated artifacts; run the generator and commit the results.
- Assistant hard rule: never include patches that directly modify generated
  files (e.g., assets/rrstackconfig.schema.json). Instead, modify the source
  generator (scripts/gen-schema.ts and related schemas) and then execute the
  generation step (e.g., `npm run schema` or `npm run docs`) to refresh artifacts.

Packaging and build

- Respect the existing Rollup config:
  - Treat Node built-ins and both dependencies and peerDependencies as external (including deep subpaths).
  - Use @rollup/plugin-replace to inject **RRSTACK_VERSION** (browser-safe).
  - Emit CJS and ESM bundles and .d.ts (main/module/types in package.json).
- Keep the subpath export ./react stable (ESM+CJS+types).

Library purity and surfaces

- Core library: pure (no I/O side effects). Suitable for Node/browsers/workers.
- React adapter: keep hooks thin; RRStack remains the single source of truth.

Coding & structure

- Prefer small, cohesive modules; use the ~300 LOC guidance. If a module must exceed it, propose a split plan in stan.todo.md before further changes.
- Co‑locate tests with modules (foo.ts ↔ foo.test.ts). Exercise happy paths and representative error paths.
- Follow house style: Prettier formatting + ESLint rules in repo; keep imports sorted.

Documentation cadence (gating)

- When emitting code or changing tests/docs, update .stan/system/stan.todo.md in the same turn with a succinct “Next up” and a short “Completed (recent)” entry.

Algorithmic guardrails

- Maintain DST/timezone correctness via Luxon.
- Preserve half‑open interval semantics [start, end); in 's' mode, end rounding up is required to avoid boundary false negatives.
- Keep getSegments streaming and memory-bounded; expose { limit } and throw on overflow (no silent truncation).
- Keep getEffectiveBounds probe-free for open-end detection; latest-bound uses finite/local reverse sweeps only.

Assistant ergonomics (this repo)

- React API (policy passthrough)
  - The hook `useRRStack` exposes an optional `policy?: UpdatePolicy` prop.
  - The policy is applied to both:
    - Prop ingestion (`json` → `rrstack.update(json, policy)`), and
    - Staged UI commits (timezone/rules/timeUnit via `rrstack.update(patch, policy)`).
  - Use `onNotice` in the policy to route notices centrally in apps.
- Do not modify .stan/system/stan.system.md; propose durable behavior changes here (stan.project.md) or in stan.requirements.md as appropriate.
- Respect BENCH-gated performance tests: do not enable them in CI; keep them deterministic when BENCH is set locally.
- For React hooks, preserve staged-vs-compiled semantics:
  - rrstack.rules/timezone/toJson reflect staged values before commit.
  - Queries reflect last committed compiled state until commit.
- When adding new translator behavior for descriptions, update acceptance tests and keep strict-en defaults stable for existing scenarios.

Environment

- Node >= 20; happy-dom test environment for React; Vitest for tests.
- ICU/Intl availability may vary across environments; always validate IANA time zones at runtime.

References

- Product requirements: .stan/system/stan.requirements.md
- System prompt (response format, patch rules): .stan/system/stan.system.md
